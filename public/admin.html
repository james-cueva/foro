<!-- admin.html -->
<!-- 
  Descripción: Panel del administrador para gestionar y responder publicaciones de los usuarios.
  Estilos: css/admin.css
-->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administrador - Soporte Técnico</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>
  <div class="header">
    <h1>Panel de Administración - Soporte Técnico</h1>
    <button id="cerrar-sesion">Cerrar sesión</button>
  </div>

  <div class="container" id="lista-posts"></div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    const token = localStorage.getItem('token');
    const API = window.location.origin;
    const contenedor = document.getElementById('lista-posts');

    if (!token) window.location.href = 'login.html';

    document.getElementById('cerrar-sesion').onclick = () => {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    };

    function crearEditor(div) {
      return new Quill(div, {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }, { 'size': [] }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['link', 'image', 'video'],
            ['clean']
          ]
        }
      });
    }

    async function cargarPosts() {
      const res = await fetch(`${API}/api/post/todos`, {
        headers: { 'Authorization': 'Bearer ' + token },
      });
      const posts = await res.json();
      contenedor.innerHTML = '';

      posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <h3>${post.asunto}</h3>
          <div class="ql-editor">${post.descripcion}</div>
          <p><strong>Usuario:</strong> ${post.usuario?.correo || 'Desconocido'}</p>
          <p><strong>Ticket:</strong> ${post.ticket || 'Se generará cuando haya respuesta'}</p>
          <p><em>Publicado: ${new Date(post.creado).toLocaleString()}</em></p>
        `;

        post.mensajes.forEach(m => {
          const divMsg = document.createElement('div');
          divMsg.className = `mensaje ${m.esAdmin ? 'admin' : 'usuario'}`;

          if (m.esAdmin) {
            divMsg.innerHTML = `
              <p><strong>Respuesta:</strong></p>
              <div class="ql-editor">${m.mensaje}</div>
              <footer>
                <p>Puede hacer el seguimiento de su solicitud a través del ticket <strong>${post.ticket}</strong>.</p>
                <p>Saludos cordiales.<br><strong>Administración</strong></p>
                <p><em>Respondido: ${new Date(m.creado).toLocaleString()}</em></p>
              </footer>
            `;
          } else {
            divMsg.innerHTML = `
              <div class="ql-editor">${m.mensaje}</div>
              <footer><em>Publicado: ${new Date(m.creado).toLocaleString()}</em></footer>
            `;
          }

          div.appendChild(divMsg);
        });

        const form = document.createElement('form');
        const editorDiv = document.createElement('div');
        editorDiv.className = 'editor';
        const boton = document.createElement('button');
        boton.textContent = 'Responder';

        form.onsubmit = async e => {
          e.preventDefault();
          const contenido = quill.root.innerHTML;
          await fetch(`${API}/api/post/${post._id}/mensaje`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ mensaje: contenido })
          });
          cargarPosts();
        };

        const group = document.createElement('div');
        group.className = 'form-group';
        group.appendChild(editorDiv);
        form.appendChild(group);
        form.appendChild(boton);
        div.appendChild(form);

        const quill = crearEditor(editorDiv);
        contenedor.appendChild(div);
      });
    }

    cargarPosts();
  </script>
</body>
</html>
